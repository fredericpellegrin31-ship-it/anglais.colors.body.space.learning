<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Space Learning - Colors & Body</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Quicksand:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Quicksand', sans-serif;
            background-color: #020617;
            overflow: hidden;
            user-select: none;
            color: white;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .comic-font {
            font-family: 'Fredoka One', cursive;
        }

        .space-bg {
            position: relative;
            height: 180px; 
            background: radial-gradient(circle at center, #1e1b4b 0%, #020617 100%);
            border: 4px solid #475569;
            border-radius: 24px;
            overflow: hidden;
            box-shadow: 0 0 30px rgba(99, 102, 241, 0.2);
            margin-bottom: 0.5rem;
        }

        .timer-container {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            width: 150px;
            height: 6px;
            background: rgba(255,255,255,0.2);
            border-radius: 10px;
            z-index: 20;
        }
        #timer-bar {
            width: 100%;
            height: 100%;
            background: #10b981;
            border-radius: 10px;
            transition: width 0.1s linear;
        }

        .stars-bg {
            position: absolute;
            width: 100%;
            height: 100%;
            background-image: 
                radial-gradient(1px 1px at 20px 30px, white, rgba(0,0,0,0)),
                radial-gradient(1px 1px at 40px 70px, white, rgba(0,0,0,0)),
                radial-gradient(2px 2px at 90px 40px, white, rgba(0,0,0,0));
            background-size: 200px 200px;
            animation: stars-move 8s linear infinite;
        }

        @keyframes stars-move {
            from { background-position: 0 0; }
            to { background-position: -200px 0; }
        }

        .ship-container {
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            width: 70px;
            height: 50px;
            transition: top 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 10;
        }

        .ship-sprite {
            width: 100%;
            height: 100%;
            animation: ship-hover 3s ease-in-out infinite;
        }

        @keyframes ship-hover {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            25% { transform: translateY(-5px) rotate(-2deg); }
            75% { transform: translateY(5px) rotate(2deg); }
        }

        .asteroid {
            position: absolute;
            right: -100px;
            width: 50px;
            height: 50px;
            z-index: 15;
            display: flex;
            align-items: center;
            justify-content: center;
            transform: translateY(-50%);
        }
        
        .asteroid-svg {
            width: 100%;
            height: 100%;
            animation: rotate-asteroid 6s linear infinite;
        }

        @keyframes rotate-asteroid {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .explosion {
            position: absolute;
            width: 100px;
            height: 100px;
            background: radial-gradient(circle, #fcd34d 0%, #f59e0b 30%, #ef4444 60%, transparent 80%);
            border-radius: 50%;
            transform: translate(-50%, -50%) scale(0);
            pointer-events: none;
            z-index: 30;
            display: none;
            filter: blur(5px);
        }
        .animate-explode {
            display: block !important;
            animation: explode-kf 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
        }

        @keyframes explode-kf {
            0% { transform: translate(-50%, -50%) scale(0); opacity: 1; }
            50% { transform: translate(-50%, -50%) scale(1.5); opacity: 0.8; }
            100% { transform: translate(-50%, -50%) scale(2); opacity: 0; }
        }

        .laser {
            position: absolute;
            left: 80px;
            height: 4px;
            background: #38bdf8;
            border-radius: 10px;
            box-shadow: 0 0 15px #0ea5e9;
            display: none;
            z-index: 5;
            transform: translateY(-50%);
        }

        .weather-card {
            transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            cursor: pointer;
            border: 3px solid #1e293b;
            background: #1e293b;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            padding: 8px;
            border-radius: 16px;
            overflow: hidden; /* EmpÃªche l'image de dÃ©passer */
        }

        .weather-card:not(.disabled):hover {
            transform: scale(1.03);
            border-color: #6366f1;
        }

        .weather-card.disabled {
            cursor: default;
            opacity: 0.4;
        }

        .correct { border-color: #10b981 !important; background: #064e3b !important; opacity: 1 !important; }
        .wrong { border-color: #ef4444 !important; background: #7f1d1d !important; animation: shake 0.4s; opacity: 1 !important; }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-8px); }
            75% { transform: translateX(8px); }
        }

        .impact-shake {
            animation: impact-kf 0.5s linear;
        }
        @keyframes impact-kf {
            0% { transform: translate(4px, 2px); }
            20% { transform: translate(-5px, -3px); }
            40% { transform: translate(-2px, 4px); }
            60% { transform: translate(5px, 2px); }
            80% { transform: translate(-2px, -2px); }
            100% { transform: translate(0, 0); }
        }

        .color-blob {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 3px solid rgba(255,255,255,0.3);
            box-shadow: inset 0 4px 10px rgba(0,0,0,0.4);
        }

        /* Image style within cards */
        .card-image {
            max-width: 100%;
            max-height: 80px;
            object-fit: contain;
            filter: drop-shadow(0 4px 6px rgba(0,0,0,0.3));
        }

        .hidden { display: none !important; }

        .training-card {
            background: #1e293b;
            border: 2px solid #334155;
            border-radius: 16px;
            padding: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            min-height: 100px;
        }
        .training-card:hover {
            border-color: #6366f1;
            background: #334155;
        }
        .training-label {
            margin-top: 8px;
            font-weight: bold;
            font-size: 0.85rem;
            color: #cbd5e1;
            text-transform: capitalize;
        }

        #game-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            grid-template-rows: repeat(2, 1fr);
            gap: 12px;
            flex: 1;
            min-height: 0;
        }

        .trophy-animation {
            font-size: 5rem;
            animation: trophy-bounce 1s ease-in-out infinite alternate;
            z-index: 50;
        }
        @keyframes trophy-bounce {
            from { transform: scale(1) rotate(-5deg); }
            to { transform: scale(1.1) rotate(5deg); }
        }

        #fireworks-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 40;
            display: none;
        }
    </style>
</head>
<body class="p-2 sm:p-4">

    <canvas id="fireworks-canvas"></canvas>

    <header class="w-full max-w-4xl mx-auto flex justify-between items-center mb-2 bg-slate-900/80 p-3 rounded-2xl border border-slate-700">
        <h1 class="comic-font text-xl sm:text-2xl text-indigo-400 leading-none uppercase tracking-tighter">Space Learning</h1>
        <div id="game-stats" class="hidden flex gap-2">
            <div class="bg-indigo-900/50 border border-indigo-500 px-3 py-1 rounded-lg comic-font text-xs sm:text-sm text-indigo-300">POINTS: <span id="score-val">0</span></div>
            <div class="bg-slate-800 border border-slate-600 px-3 py-1 rounded-lg comic-font text-xs sm:text-sm">WAVE: <span id="question-count">1</span>/12</div>
        </div>
    </header>

    <main class="w-full max-w-4xl mx-auto flex-1 flex flex-col overflow-hidden">
        
        <!-- START SCREEN -->
        <div id="screen-start" class="flex flex-col items-center justify-center flex-1 space-y-6">
            <div class="relative">
                <div class="w-24 h-24 bg-indigo-500/20 rounded-full absolute -inset-4 animate-ping"></div>
                <div class="w-24 h-24 bg-slate-800 border-4 border-indigo-500 rounded-full flex items-center justify-center text-5xl shadow-xl">ðŸš€</div>
            </div>
            <div class="text-center space-y-2 px-6">
                <h2 class="comic-font text-2xl text-indigo-300 uppercase">Colors & Body</h2>
                <p class="text-slate-400">Listen to the space sounds. 12 missions to complete.</p>
            </div>
            <div class="flex flex-col gap-4 w-full max-w-xs px-4">
                <button id="btn-play" onclick="startGame()" class="px-8 py-4 bg-indigo-600 rounded-xl border-b-4 border-indigo-900 hover:translate-y-1 transition-all comic-font text-xl uppercase tracking-wider">Play</button>
                <button onclick="startTraining()" class="px-8 py-3 bg-slate-800 rounded-xl border-b-4 border-slate-950 hover:translate-y-1 transition-all comic-font text-lg text-slate-300 uppercase tracking-wider">Training</button>
            </div>
        </div>

        <!-- TRAINING SCREEN -->
        <div id="screen-training" class="hidden flex-1 flex flex-col min-h-0 bg-slate-900/40 rounded-3xl border border-slate-700 p-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="comic-font text-xl text-indigo-400 uppercase">Practice</h3>
                <button onclick="showStartScreen()" class="px-4 py-2 bg-slate-700 rounded-lg text-sm comic-font uppercase">Menu</button>
            </div>
            <div class="flex-1 overflow-y-auto space-y-6 pr-2">
                <div>
                    <h4 class="text-xs comic-font text-slate-500 mb-2 uppercase tracking-widest">Colors</h4>
                    <div id="training-colors" class="grid grid-cols-3 sm:grid-cols-4 gap-3"></div>
                </div>
                <div>
                    <h4 class="text-xs comic-font text-slate-500 mb-2 uppercase tracking-widest">Human Body</h4>
                    <div id="training-body" class="grid grid-cols-3 sm:grid-cols-4 gap-3"></div>
                </div>
            </div>
        </div>

        <!-- GAME SCREEN -->
        <div id="screen-game" class="hidden flex-1 flex flex-col min-h-0">
            <div id="viewport" class="space-bg shrink-0">
                <div class="stars-bg"></div>
                <div class="timer-container"><div id="timer-bar"></div></div>
                <div id="laser" class="laser"></div>
                <div id="explosion-effect" class="explosion"></div>
                
                <div id="ship" class="ship-container">
                    <div class="ship-sprite">
                        <svg viewBox="0 0 100 80">
                            <path d="M5 35 L-20 40 L5 45 Z" fill="#f59e0b">
                                <animate attributeName="d" values="M5 35 L-15 40 L5 45 Z; M5 35 L-25 40 L5 45 Z; M5 35 L-15 40 L5 45 Z" dur="0.15s" repeatCount="indefinite" />
                            </path>
                            <path d="M10 20 L40 10 L85 25 L95 40 L85 55 L40 70 L10 60 Z" fill="#64748b" stroke="#1e293b" stroke-width="2"/>
                            <path d="M55 25 Q75 25 85 40 Q75 55 55 55 Z" fill="#38bdf8" fill-opacity="0.8" stroke="white" stroke-width="1.5"/>
                            <rect x="25" y="35" width="8" height="10" rx="2" fill="#ef4444" />
                        </svg>
                    </div>
                </div>

                <div id="asteroid" class="asteroid">
                    <div class="asteroid-svg">
                        <svg viewBox="0 0 100 100">
                            <path d="M20 30 Q10 50 30 80 Q50 95 80 80 Q95 50 70 20 Q50 5 20 30" fill="#4b5563" stroke="black" stroke-width="3"/>
                            <circle cx="40" cy="40" r="8" fill="#374151"/>
                        </svg>
                    </div>
                </div>
            </div>

            <div class="flex-1 flex flex-col bg-slate-900/40 rounded-2xl border border-slate-700 p-3 min-h-0 overflow-hidden">
                <div class="flex items-center justify-center gap-3 mb-2 shrink-0">
                    <button onclick="playTargetSound()" class="bg-indigo-600 p-3 rounded-full shadow-lg border-b-4 border-indigo-800 active:translate-y-1">
                        <svg class="h-8 w-8 text-white" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M9.383 3.076A1 1 0 0110 4v12a1 1 0 01-1.707.707L4.586 13H2a1 1 0 01-1-1V8a1 1 0 011-1h2.586l3.707-3.707a1 1 0 011.09-.217zM14.657 2.929a1 1 0 011.414 0A9.972 9.972 0 0119 10a9.972 9.972 0 01-2.929 7.071a1 1 0 01-1.414-1.414A7.971 7.971 0 0017 10c0-2.21-.894-4.208-2.343-5.657a1 1 0 010-1.414z" />
                        </svg>
                    </button>
                    <div id="current-category" class="text-xs comic-font text-indigo-400 uppercase tracking-widest">LISTEN CAREFULLY!</div>
                </div>
                <div id="game-grid"></div>
            </div>
        </div>

        <!-- END SCREEN -->
        <div id="screen-end" class="hidden text-center flex-1 flex flex-col items-center justify-center space-y-4 relative z-50">
            <h2 id="end-title" class="text-3xl comic-font text-indigo-400 italic uppercase">Mission Complete</h2>
            <div class="bg-slate-900 p-8 rounded-3xl border-2 border-indigo-500 shadow-2xl w-full max-w-sm">
                <p class="text-xl mb-2 comic-font">SCORE: <span id="final-score" class="text-indigo-400">0</span> / 12</p>
                <div id="stars-display" class="flex justify-center gap-2 mb-6 h-20 items-center"></div>
                <button onclick="location.reload()" class="bg-indigo-600 text-white w-full py-4 rounded-xl text-lg comic-font border-b-4 border-indigo-900 uppercase">Restart</button>
            </div>
        </div>

    </main>

    <script>
        const colorData = [
            { id: 'yellow', text: "Yellow", hex: "#facc15" },
            { id: 'red', text: "Red", hex: "#ef4444" },
            { id: 'blue', text: "Blue", hex: "#3b82f6" },
            { id: 'green', text: "Green", hex: "#22c55e" },
            { id: 'black', text: "Black", hex: "#000000" },
            { id: 'white', text: "White", hex: "#ffffff" },
            { id: 'orange', text: "Orange", hex: "#f97316" },
            { id: 'pink', text: "Pink", hex: "#ec4899" },
            { id: 'purple', text: "Purple", hex: "#a855f7" },
            { id: 'grey', text: "Grey", hex: "#94a3b8" },
            { id: 'brown', text: "Brown", hex: "#78350f" }
        ];

        const bodyData = [
            { id: 'head', text: "Head", img: "HEAD.png" },
            { id: 'shoulders', text: "Shoulders", img: "SHOULDERS.png" }, 
            { id: 'knees', text: "Knees", img: "KNEES.png" },
            { id: 'toes', text: "Toes", img: "TOES.png" },
            { id: 'eyes', text: "Eyes", img: "EYE.png" },
            { id: 'ears', text: "Ears", img: "EAR.png" },
            { id: 'mouth', text: "Mouth", img: "MOUTH.png" },
            { id: 'nose', text: "Nose", img: "NOSE.png" },
            { id: 'hair', text: "Hair", img: "HAIR.png" },
            { id: 'teeth', text: "Teeth", img: "TEETH.png" },
            { id: 'small', text: "Small", img: "SMALL.png" },
            { id: 'big', text: "Big", img: "BIG (2).png" }
        ];

        let score = 0;
        let question = 1;
        let target = null;
        let canAnswer = true;
        let currentLevelTime = 8000;
        let timerId = null;
        let startTime = 0;
        let audioCtx = null;

        const ship = document.getElementById('ship');
        const asteroid = document.getElementById('asteroid');
        const laser = document.getElementById('laser');
        const gameGrid = document.getElementById('game-grid');
        const timerBar = document.getElementById('timer-bar');
        const explosion = document.getElementById('explosion-effect');
        const viewport = document.getElementById('viewport');

        function initAudio() {
            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            }
            if (audioCtx.state === 'suspended') {
                audioCtx.resume();
            }
        }

        function playSound(type) {
            if (!audioCtx) return;
            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);

            if (type === 'laser') {
                oscillator.type = 'sawtooth';
                oscillator.frequency.setValueAtTime(800, audioCtx.currentTime);
                oscillator.frequency.exponentialRampToValueAtTime(40, audioCtx.currentTime + 0.1);
                gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
                oscillator.start();
                oscillator.stop(audioCtx.currentTime + 0.1);
            } else if (type === 'explosion') {
                oscillator.type = 'square';
                oscillator.frequency.setValueAtTime(100, audioCtx.currentTime);
                oscillator.frequency.exponentialRampToValueAtTime(10, audioCtx.currentTime + 0.3);
                gainNode.gain.setValueAtTime(0.2, audioCtx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
                oscillator.start();
                oscillator.stop(audioCtx.currentTime + 0.3);
            }
        }

        function speak(text) {
            window.speechSynthesis.cancel();
            const msg = new SpeechSynthesisUtterance(text);
            msg.lang = 'en-US'; 
            msg.rate = 0.9;
            window.speechSynthesis.speak(msg);
        }

        function showStartScreen() {
            document.getElementById('screen-start').classList.remove('hidden');
            document.getElementById('screen-training').classList.add('hidden');
            document.getElementById('screen-game').classList.add('hidden');
            document.getElementById('game-stats').classList.add('hidden');
        }

        function startTraining() {
            initAudio();
            document.getElementById('screen-start').classList.add('hidden');
            document.getElementById('screen-training').classList.remove('hidden');
            
            const colContainer = document.getElementById('training-colors');
            const bodyContainer = document.getElementById('training-body');
            
            colContainer.innerHTML = '';
            bodyContainer.innerHTML = '';

            colorData.forEach(item => {
                const card = createTrainingCard(item, true);
                colContainer.appendChild(card);
            });

            bodyData.forEach(item => {
                const card = createTrainingCard(item, false);
                bodyContainer.appendChild(card);
            });
        }

        function createContentHTML(item) {
            if (item.img) {
                return `<img src="${item.img}" alt="${item.text}" class="card-image" />`;
            } else if (item.emoji) {
                return `<span class="text-4xl">${item.emoji}</span>`;
            }
            return '';
        }

        function createTrainingCard(item, isColor) {
            const card = document.createElement('div');
            card.className = "training-card";
            if (isColor) {
                card.innerHTML = `<div class="w-10 h-10 rounded-full border border-white/20 shadow-inner" style="background-color: ${item.hex}"></div>`;
            } else {
                card.innerHTML = createContentHTML(item);
                // Pas de texte en anglais ici (suppression demandÃ©e)
            }
            
            card.onclick = () => speak(item.text);
            return card;
        }

        function startGame() {
            initAudio();
            document.getElementById('screen-start').classList.add('hidden');
            document.getElementById('screen-game').classList.remove('hidden');
            document.getElementById('game-stats').classList.remove('hidden');
            score = 0;
            question = 1;
            currentLevelTime = 8000;
            document.getElementById('score-val').innerText = score;
            nextQuestion();
        }

        function nextQuestion() {
            if (question > 12) return endGame();
            
            canAnswer = true;
            document.getElementById('question-count').innerText = question;
            
            const isColorWave = question % 2 !== 0; 
            const sourcePool = isColorWave ? colorData : bodyData;
            document.getElementById('current-category').innerText = isColorWave ? "Mission: Find the color" : "Mission: Human body";

            const yPos = (Math.random() * 50 + 25) + '%';
            ship.style.top = yPos;
            ship.style.filter = '';

            asteroid.style.transition = 'none';
            asteroid.style.right = '-100px'; 
            asteroid.style.top = yPos; 
            asteroid.style.display = 'flex';
            asteroid.style.opacity = '1';

            laser.style.display = 'none';
            explosion.classList.remove('animate-explode');

            target = sourcePool[Math.floor(Math.random() * sourcePool.length)];
            let others = sourcePool.filter(w => w.id !== target.id).sort(() => 0.5 - Math.random());
            
            let options = [target, others[0], others[1], others[2]]
                .sort(() => 0.5 - Math.random());

            gameGrid.innerHTML = '';
            options.forEach(opt => {
                const btn = document.createElement('div');
                btn.className = "weather-card";
                
                if (isColorWave) {
                    btn.innerHTML = `<div class="color-blob" style="background-color: ${opt.hex}"></div>`;
                } else {
                    btn.innerHTML = createContentHTML(opt);
                }
                
                btn.onclick = () => check(opt.id, btn);
                gameGrid.appendChild(btn);
            });

            setTimeout(() => {
                asteroid.style.transition = `right ${currentLevelTime}ms linear`;
                asteroid.style.right = (viewport.offsetWidth - 80) + 'px';
                playTargetSound();
                startTimer();
            }, 100);
        }

        function startTimer() {
            clearInterval(timerId);
            startTime = Date.now();
            timerBar.style.width = "100%";
            timerBar.style.backgroundColor = "#10b981";
            
            timerId = setInterval(() => {
                let elapsed = Date.now() - startTime;
                let remaining = Math.max(0, 100 - (elapsed / currentLevelTime * 100));
                timerBar.style.width = remaining + "%";
                if (remaining < 30) timerBar.style.backgroundColor = "#ef4444";
                if (elapsed >= currentLevelTime) handleCollision();
            }, 50);
        }

        function playTargetSound() { if(target) speak(target.text); }

        function handleCollision() {
            clearInterval(timerId);
            if (!asteroid.style.display || asteroid.style.display === 'none') return;

            playSound('explosion');
            
            explosion.style.top = "50%";
            explosion.style.left = "80px";
            explosion.classList.add('animate-explode');
            
            viewport.classList.add('impact-shake');
            asteroid.style.display = 'none';
            
            ship.style.filter = 'drop-shadow(0 0 20px #ef4444) brightness(1.5)';
            ship.animate([
                { transform: 'translateY(-50%) translateX(0px)' },
                { transform: 'translateY(-50%) translateX(-15px)' },
                { transform: 'translateY(-50%) translateX(10px)' },
                { transform: 'translateY(-50%) translateX(0px)' }
            ], { duration: 500 });
            
            setTimeout(() => {
                viewport.classList.remove('impact-shake');
                question++;
                nextQuestion();
            }, 1000);
        }

        function check(id, el) {
            if(!canAnswer) return;
            canAnswer = false; 

            Array.from(gameGrid.children).forEach(child => {
                if (child !== el) child.classList.add('disabled');
            });

            if(id === target.id) {
                clearInterval(timerId);
                const currentRight = getComputedStyle(asteroid).right;
                asteroid.style.transition = 'none';
                asteroid.style.right = currentRight;

                score++;
                el.classList.add('correct');
                
                const viewBounds = viewport.getBoundingClientRect();
                const shipBounds = ship.getBoundingClientRect();
                const astBounds = asteroid.getBoundingClientRect();

                const shipCenterY = shipBounds.top - viewBounds.top + (shipBounds.height / 2);
                laser.style.top = shipCenterY + "px";
                
                const startX = shipBounds.right - viewBounds.left;
                const endX = astBounds.left - viewBounds.left;
                laser.style.left = (startX - 15) + "px"; 
                laser.style.width = Math.max(0, endX - startX + 30) + "px";
                laser.style.display = 'block';

                playSound('laser');
                
                setTimeout(() => {
                    playSound('explosion');
                    explosion.style.top = (astBounds.top - viewBounds.top + (astBounds.height / 2)) + "px";
                    explosion.style.left = (astBounds.left - viewBounds.left + (astBounds.width / 2)) + "px";
                    explosion.classList.add('animate-explode');
                    
                    asteroid.style.opacity = '0';
                    document.getElementById('score-val').innerText = score;
                    currentLevelTime = Math.max(2500, currentLevelTime - 450);
                    
                    setTimeout(() => {
                        question++;
                        nextQuestion();
                    }, 1500);
                }, 100);
            } else {
                el.classList.add('wrong');
                speak("Oh no!");
                // No more action, wait for collision via timer
            }
        }

        const canvas = document.getElementById('fireworks-canvas');
        const ctx = canvas.getContext('2d');
        let particles = [];

        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }
        window.onresize = resizeCanvas;
        resizeCanvas();

        class Particle {
            constructor(x, y, color) {
                this.x = x;
                this.y = y;
                this.color = color;
                this.velocity = {
                    x: (Math.random() - 0.5) * 8,
                    y: (Math.random() - 0.5) * 8
                };
                this.alpha = 1;
                this.friction = 0.95;
            }
            draw() {
                ctx.globalAlpha = this.alpha;
                ctx.beginPath();
                ctx.arc(this.x, this.y, 2, 0, Math.PI * 2);
                ctx.fillStyle = this.color;
                ctx.fill();
            }
            update() {
                this.velocity.x *= this.friction;
                this.velocity.y *= this.friction;
                this.x += this.velocity.x;
                this.y += this.velocity.y;
                this.alpha -= 0.01;
            }
        }

        function createFirework(x, y) {
            const colors = ['#818cf8', '#6366f1', '#4f46e5', '#f472b6', '#fbbf24'];
            const color = colors[Math.floor(Math.random() * colors.length)];
            for (let i = 0; i < 40; i++) {
                particles.push(new Particle(x, y, color));
            }
        }

        function animateFireworks() {
            if (canvas.style.display === 'none') return;
            ctx.fillStyle = 'rgba(2, 6, 23, 0.1)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            particles.forEach((p, i) => {
                if (p.alpha > 0) {
                    p.update();
                    p.draw();
                } else {
                    particles.splice(i, 1);
                }
            });

            if (Math.random() < 0.05) {
                createFirework(Math.random() * canvas.width, Math.random() * canvas.height);
            }
            requestAnimationFrame(animateFireworks);
        }

        function endGame() {
            clearInterval(timerId);
            document.getElementById('screen-game').classList.add('hidden');
            document.getElementById('screen-end').classList.remove('hidden');
            document.getElementById('final-score').innerText = score;
            
            const starsContainer = document.getElementById('stars-display');
            starsContainer.innerHTML = '';
            
            if (score === 12) {
                const trophy = document.createElement('div');
                trophy.className = "trophy-animation";
                trophy.innerText = "ðŸ†";
                starsContainer.appendChild(trophy);
                document.getElementById('end-title').innerText = "SPACE CHAMPION!";
                
                canvas.style.display = 'block';
                animateFireworks();
            } else {
                let starsCount = score >= 10 ? 3 : (score >= 6 ? 2 : 1);
                for (let i = 0; i < 3; i++) {
                    const star = document.createElement('span');
                    star.className = "text-5xl";
                    star.innerText = i < starsCount ? "â­" : "âš«";
                    if (i >= starsCount) star.style.opacity = "0.2";
                    starsContainer.appendChild(star);
                }
            }
        }
    </script>
</body>
</html>

